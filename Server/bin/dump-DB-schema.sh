#!/bin/bash
# Coop-specific variables:
# Fancy way of determining the directory of this script
SOURCE="${BASH_SOURCE[0]}"
while [ -h "$SOURCE" ]; do # resolve $SOURCE until the file is no longer a symlink
  BIN_DIR="$( cd -P "$( dirname "$SOURCE" )" && pwd )"
  SOURCE="$(readlink "$SOURCE")"
  [[ $SOURCE != /* ]] && SOURCE="$BIN_DIR/$SOURCE" # if $SOURCE was a relative symlink, we need to resolve it relative to the path where the symlink file was located
done
BIN_DIR="$( cd -P "$( dirname "$SOURCE" )" && pwd )"
# File with site-specific variables
source ${BIN_DIR}/coop_defs.sh

DB_CNF="${ROOT_DIR}/priv/DB_BACKUP.cnf"
SCHEMA_FILENAME="BBD-Schema-${ISO_DATE}.sql"
cat > "${SCHEMA_FILENAME}" <<EOF
-- File ${SCHEMA_FILENAME} generated by ${0##*/} on ${DATE}
-- -------------------------------------------------------------
-- BBD9000 CMS Schema Dump
--   This file is used to build a new empty BBD9000 CMS database
--   Includes BBD9000 system table data
-- -------------------------------------------------------------
EOF

# First dump structure and data for BBD system tables (i.e. tables with BBD system data)
# FIXME: should look up in a table of system table names instead of specifying them in this script.
mysqldump --defaults-extra-file=$DB_CNF \
	--skip-extended-insert --skip-compact --single-transaction ${DB_NAME} \
	roles item_prices alerts alert_roles promotions  \
	| sed 's/AUTO_INCREMENT=[0-9]*\b//' \
	>> ${SCHEMA_FILENAME}
# Append the rest of the tables, excluding the system tables.
mysqldump --defaults-extra-file=$DB_CNF --single-transaction --no-data ${DB_NAME} \
	--ignore-table=${DB_NAME}.roles \
	--ignore-table=${DB_NAME}.item_prices \
	--ignore-table=${DB_NAME}.alerts \
	--ignore-table=${DB_NAME}.alert_roles \
	--ignore-table=${DB_NAME}.promotions \
	| sed 's/AUTO_INCREMENT=[0-9]*\b//' \
	>> ${SCHEMA_FILENAME}
